{{define "content"}}
<div class="card">
    <h2>Session: {{slice .Session.ID 0 16}}...</h2>
    <p style="color: #666; margin-bottom: 20px; font-family: monospace; font-size: 12px;">Full ID: {{.Session.ID}}</p>
    
    <table style="margin-bottom: 20px;">
        <tr>
            <th style="width: 200px;">Created</th>
            <td>{{.Session.CreatedAt.Format "2006-01-02 15:04:05"}}</td>
        </tr>
        <tr>
            <th>Updated</th>
            <td>{{.Session.UpdatedAt.Format "2006-01-02 15:04:05"}}</td>
        </tr>
        {{if .Session.EndedAt}}
        <tr>
            <th>Ended</th>
            <td>{{.Session.EndedAt.Format "2006-01-02 15:04:05"}}</td>
        </tr>
        {{end}}
        <tr>
            <th>Status</th>
            <td>
                {{if .Session.Active}}
                    <span class="badge badge-active">Active</span>
                {{else}}
                    <span class="badge badge-inactive">Ended</span>
                {{end}}
            </td>
        </tr>
        <tr>
            <th>State Changes</th>
            <td>{{len .Session.StateHistory}} updates recorded</td>
        </tr>
    </table>
</div>

<!-- State Timeline -->
{{if .Session.StateHistory}}
<div class="card">
    <h2>State Change Timeline</h2>
    <p style="margin-bottom: 20px; color: #666;">
        Click on any point to view the cumulative state at that moment in time.
    </p>
    
    <div style="position: relative; margin: 30px 0;">
        <!-- Timeline line -->
        <div style="position: absolute; top: 20px; left: 0; right: 0; height: 2px; background: #ddd;"></div>
        
        <!-- Timeline points -->
        <div style="display: flex; justify-content: space-between; position: relative;">
            {{range $index, $snapshot := .Session.StateHistory}}
            <div style="flex: 0 0 auto; text-align: center; z-index: 1;">
                <div class="timeline-point" 
                     data-index="{{$index}}"
                     style="width: 20px; height: 20px; border-radius: 50%; background: #667eea; margin: 10px auto; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s;"
                     onmouseover="this.style.transform='scale(1.3)'"
                     onmouseout="this.style.transform='scale(1)'"
                     onclick="showStateAtIndex({{$index}})">
                </div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    {{$snapshot.Timestamp.Format "15:04:05"}}
                </div>
            </div>
            {{end}}
        </div>
    </div>
    
    <!-- State display area -->
    <div id="state-display" style="margin-top: 30px; display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 id="state-title" style="margin: 0;">State at: <span id="state-time"></span></h3>
            <button onclick="closeStateDisplay()" class="btn btn-secondary" style="padding: 5px 15px; font-size: 13px;">Close</button>
        </div>
        <pre id="state-content" style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; max-height: 500px;"></pre>
    </div>
</div>

<script>
const stateHistory = [
    {{range .Session.StateHistory}}
    {
        timestamp: "{{.Timestamp.Format "2006-01-02 15:04:05"}}",
        state: {{.State | printf "%#v"}}
    },
    {{end}}
];

function showStateAtIndex(index) {
    const snapshot = stateHistory[index];
    const display = document.getElementById('state-display');
    const title = document.getElementById('state-time');
    const content = document.getElementById('state-content');
    
    title.textContent = snapshot.timestamp;
    content.textContent = JSON.stringify(snapshot.state, null, 2);
    display.style.display = 'block';
    
    // Scroll to the state display
    display.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    // Highlight the selected point
    document.querySelectorAll('.timeline-point').forEach((point, i) => {
        if (i === index) {
            point.style.background = '#764ba2';
            point.style.transform = 'scale(1.3)';
        } else {
            point.style.background = '#667eea';
            point.style.transform = 'scale(1)';
        }
    });
}

function closeStateDisplay() {
    document.getElementById('state-display').style.display = 'none';
    
    // Reset all points
    document.querySelectorAll('.timeline-point').forEach(point => {
        point.style.background = '#667eea';
        point.style.transform = 'scale(1)';
    });
}
</script>
{{end}}

<div class="card">
    <h3>Current State</h3>
    <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto;">{{.Session.State | printf "%#v"}}</pre>
</div>

<!-- Metrics Timeseries Visualization -->
{{if .Session.Metrics}}
<div class="card">
    <h2>Metrics Timeseries</h2>
    <p style="margin-bottom: 15px; color: #666;">
        Visualize how metrics changed over time during this session.
    </p>
    
    <div id="metric-charts"></div>
</div>

<script>
(function() {
    // Group metrics by name
    const metricsByName = {};
    const metrics = [
        {{range .Session.Metrics}}
        {
            name: "{{.Name}}",
            timestamp: new Date("{{.Timestamp.Format "2006-01-02T15:04:05Z07:00"}}"),
            value: {{.Value}},
            tags: [{{range .Tags}}"{{.}}",{{end}}]
        },
        {{end}}
    ];

    metrics.forEach(m => {
        if (!metricsByName[m.name]) {
            metricsByName[m.name] = [];
        }
        metricsByName[m.name].push(m);
    });

    // Create a chart for each metric
    const container = document.getElementById('metric-charts');
    Object.keys(metricsByName).sort().forEach((metricName, index) => {
        const metricData = metricsByName[metricName];
        
        // Sort by timestamp
        metricData.sort((a, b) => a.timestamp - b.timestamp);
        
        // Calculate statistics
        const values = metricData.map(m => m.value);
        const peak = Math.max(...values);
        const min = Math.min(...values);
        const avg = values.reduce((a, b) => a + b, 0) / values.length;
        
        // Create container for this chart
        const chartDiv = document.createElement('div');
        chartDiv.style.marginBottom = '30px';
        
        const title = document.createElement('h3');
        title.textContent = metricName;
        title.style.marginBottom = '10px';
        chartDiv.appendChild(title);
        
        const stats = document.createElement('p');
        stats.style.fontSize = '14px';
        stats.style.color = '#666';
        stats.style.marginBottom = '10px';
        stats.innerHTML = `<strong>Peak:</strong> ${peak.toFixed(2)} | <strong>Average:</strong> ${avg.toFixed(2)} | <strong>Min:</strong> ${min.toFixed(2)} | <strong>Points:</strong> ${metricData.length}`;
        chartDiv.appendChild(stats);
        
        const canvasContainer = document.createElement('div');
        canvasContainer.style.position = 'relative';
        canvasContainer.style.height = '300px';
        canvasContainer.style.marginBottom = '20px';
        
        const canvas = document.createElement('canvas');
        canvas.id = 'chart-' + index;
        canvasContainer.appendChild(canvas);
        chartDiv.appendChild(canvasContainer);
        
        container.appendChild(chartDiv);
        
        // Create chart
        new Chart(canvas, {
            type: 'line',
            data: {
                labels: metricData.map(m => m.timestamp),
                datasets: [{
                    label: metricName,
                    data: metricData.map(m => m.value),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                return metricName + ': ' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                second: 'HH:mm:ss',
                                minute: 'HH:mm',
                                hour: 'HH:mm'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Value'
                        }
                    }
                }
            }
        });
    });
})();
</script>
{{end}}

<!-- Events Table -->
<div class="card">
    <h3>Events ({{len .Session.Events}})</h3>
    <table>
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Name</th>
                <th>Data</th>
            </tr>
        </thead>
        <tbody>
            {{range .Session.Events}}
            <tr>
                <td>{{.Timestamp.Format "15:04:05"}}</td>
                <td><strong>{{.Name}}</strong></td>
                <td><pre style="margin: 0;">{{.Data | printf "%v"}}</pre></td>
            </tr>
            {{else}}
            <tr>
                <td colspan="3" style="text-align: center; padding: 20px; color: #999;">No events</td>
            </tr>
            {{end}}
        </tbody>
    </table>
</div>

<!-- Metrics Table -->
<div class="card">
    <h3>Metrics Data ({{len .Session.Metrics}})</h3>
    <table>
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Name</th>
                <th>Value</th>
                <th>Tags</th>
            </tr>
        </thead>
        <tbody>
            {{range .Session.Metrics}}
            <tr>
                <td>{{.Timestamp.Format "15:04:05"}}</td>
                <td><strong>{{.Name}}</strong></td>
                <td>{{printf "%.2f" .Value}}</td>
                <td>{{range .Tags}}<span class="badge" style="background: #e9ecef; color: #495057; margin: 2px;">{{.}}</span>{{end}}</td>
            </tr>
            {{else}}
            <tr>
                <td colspan="4" style="text-align: center; padding: 20px; color: #999;">No metrics</td>
            </tr>
            {{end}}
        </tbody>
    </table>
</div>

<a href="/" class="btn btn-secondary">Back to Dashboard</a>
{{end}}
