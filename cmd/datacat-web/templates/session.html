{{define "content"}}
<div class="card">
    <h2>Session: {{slice .Session.ID 0 16}}...</h2>
    <p style="color: #666; margin-bottom: 20px; font-family: monospace; font-size: 12px;">Full ID: {{.Session.ID}}</p>
    
    <table style="margin-bottom: 20px;">
        <tr>
            <th style="width: 200px;">Created</th>
            <td>{{.Session.CreatedAt.Format "2006-01-02 15:04:05"}}</td>
        </tr>
        <tr>
            <th>Updated</th>
            <td>{{.Session.UpdatedAt.Format "2006-01-02 15:04:05"}}</td>
        </tr>
        {{if .Session.EndedAt}}
        <tr>
            <th>Ended</th>
            <td>{{.Session.EndedAt.Format "2006-01-02 15:04:05"}}</td>
        </tr>
        {{end}}
        <tr>
            <th>Status</th>
            <td>
                {{if .Session.Active}}
                    <span class="badge badge-active">Active</span>
                {{else}}
                    <span class="badge badge-inactive">Ended</span>
                {{end}}
            </td>
        </tr>
        <tr>
            <th>State Changes</th>
            <td>{{len .Session.StateHistory}} updates recorded</td>
        </tr>
    </table>
</div>

<!-- Session Timeline with Events, State Changes, and Exceptions -->
<div class="card">
    <h2>Session Timeline</h2>
    <p style="margin-bottom: 20px; color: #666;">
        Complete session lifecycle showing all state changes, events, and exceptions. Click on any point to see details.
    </p>
    
    <!-- Legend -->
    <div style="display: flex; gap: 20px; margin-bottom: 20px; font-size: 13px;">
        <div style="display: flex; align-items: center; gap: 5px;">
            <div style="width: 14px; height: 14px; border-radius: 50%; background: #667eea; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
            <span>State Change</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <div style="width: 14px; height: 14px; border-radius: 50%; background: #48bb78; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
            <span>Event</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <div style="width: 14px; height: 14px; border-radius: 50%; background: #f56565; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
            <span>Exception</span>
        </div>
    </div>
    
    <div style="position: relative; margin: 30px 0; min-height: 100px;">
        <!-- Timeline line -->
        <div style="position: absolute; top: 40px; left: 0; right: 0; height: 2px; background: #ddd;"></div>
        
        <!-- Timeline points container -->
        <div id="timeline-container" style="position: relative;"></div>
    </div>
    
    <!-- Details display area -->
    <div id="timeline-details" style="margin-top: 30px; display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 id="details-title" style="margin: 0;"></h3>
            <button onclick="closeTimelineDetails()" class="btn btn-secondary" style="padding: 5px 15px; font-size: 13px;">Close</button>
        </div>
        <div id="details-content" style="background: #f8f9fa; padding: 15px; border-radius: 4px;"></div>
    </div>
</div>

<script>
// Prepare timeline data
const timelineItems = [];

// Add state changes
{{range $index, $snapshot := .Session.StateHistory}}
timelineItems.push({
    type: 'state',
    timestamp: new Date("{{$snapshot.Timestamp.Format "2006-01-02T15:04:05Z07:00"}}"),
    displayTime: "{{$snapshot.Timestamp.Format "15:04:05"}}",
    index: {{$index}},
    data: {{$snapshot.State | printf "%#v"}}
});
{{end}}

// Add events
{{range $event := .Session.Events}}
timelineItems.push({
    type: 'event',
    timestamp: new Date("{{$event.Timestamp.Format "2006-01-02T15:04:05Z07:00"}}"),
    displayTime: "{{$event.Timestamp.Format "15:04:05"}}",
    name: "{{$event.Name}}",
    data: {{$event.Data | printf "%#v"}}
});
{{end}}

// Sort by timestamp
timelineItems.sort((a, b) => a.timestamp - b.timestamp);

// Calculate positions and render
if (timelineItems.length > 0) {
    const container = document.getElementById('timeline-container');
    const startTime = timelineItems[0].timestamp.getTime();
    const endTime = timelineItems[timelineItems.length - 1].timestamp.getTime();
    const duration = endTime - startTime || 1;
    
    timelineItems.forEach((item, index) => {
        const position = ((item.timestamp.getTime() - startTime) / duration) * 100;
        
        // Determine color based on type
        let color = '#667eea'; // state
        if (item.type === 'event') {
            // Check if it's an exception event
            if (item.name === 'exception' || item.name === 'error') {
                color = '#f56565';
            } else {
                color = '#48bb78';
            }
        }
        
        const point = document.createElement('div');
        point.style.position = 'absolute';
        point.style.left = position + '%';
        point.style.transform = 'translateX(-50%)';
        point.style.textAlign = 'center';
        point.style.zIndex = '1';
        point.style.cursor = 'pointer';
        
        const dot = document.createElement('div');
        dot.className = 'timeline-dot';
        dot.style.width = '16px';
        dot.style.height = '16px';
        dot.style.borderRadius = '50%';
        dot.style.background = color;
        dot.style.margin = '32px auto 5px';
        dot.style.border = '3px solid white';
        dot.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
        dot.style.transition = 'transform 0.2s';
        dot.dataset.index = index;
        
        dot.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.5)';
        });
        
        dot.addEventListener('mouseleave', function() {
            if (!this.classList.contains('selected')) {
                this.style.transform = 'scale(1)';
            }
        });
        
        dot.addEventListener('click', function() {
            showTimelineItem(index);
        });
        
        const label = document.createElement('div');
        label.style.fontSize = '10px';
        label.style.color = '#666';
        label.textContent = item.displayTime;
        
        point.appendChild(dot);
        point.appendChild(label);
        container.appendChild(point);
    });
}

function showTimelineItem(index) {
    const item = timelineItems[index];
    const display = document.getElementById('timeline-details');
    const title = document.getElementById('details-title');
    const content = document.getElementById('details-content');
    
    // Build title
    let titleText = '';
    if (item.type === 'state') {
        titleText = 'State Change @ ' + item.displayTime;
    } else if (item.type === 'event') {
        titleText = 'Event: ' + item.name + ' @ ' + item.displayTime;
    }
    title.textContent = titleText;
    
    // Build content
    let contentHTML = '';
    if (item.type === 'state') {
        // Find cumulative state at this point
        const stateAtThisPoint = findCumulativeState(index);
        contentHTML = '<h4 style="margin-top: 0;">Cumulative State at this Point:</h4>';
        contentHTML += '<pre style="background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px; overflow-x: auto; max-height: 400px;">' + JSON.stringify(stateAtThisPoint, null, 2) + '</pre>';
    } else if (item.type === 'event') {
        contentHTML = '<h4 style="margin-top: 0;">Event Data:</h4>';
        contentHTML += '<pre style="background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px; overflow-x: auto;">' + JSON.stringify(item.data, null, 2) + '</pre>';
        
        // Also show state at this point
        const stateAtEvent = findCumulativeStateAtTime(item.timestamp);
        if (stateAtEvent) {
            contentHTML += '<h4 style="margin-top: 15px;">Application State at Event Time:</h4>';
            contentHTML += '<pre style="background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px; overflow-x: auto; max-height: 300px;">' + JSON.stringify(stateAtEvent, null, 2) + '</pre>';
        }
    }
    
    content.innerHTML = contentHTML;
    display.style.display = 'block';
    display.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    // Highlight selected point
    document.querySelectorAll('.timeline-dot').forEach((dot, i) => {
        if (i === index) {
            dot.classList.add('selected');
            dot.style.transform = 'scale(1.5)';
        } else {
            dot.classList.remove('selected');
            dot.style.transform = 'scale(1)';
        }
    });
}

function findCumulativeState(timelineIndex) {
    // Find the last state change before or at this timeline index
    for (let i = timelineIndex; i >= 0; i--) {
        if (timelineItems[i].type === 'state') {
            return timelineItems[i].data;
        }
    }
    return {};
}

function findCumulativeStateAtTime(eventTime) {
    // Find the last state change before this event
    for (let i = timelineItems.length - 1; i >= 0; i--) {
        const item = timelineItems[i];
        if (item.type === 'state' && item.timestamp <= eventTime) {
            return item.data;
        }
    }
    return null;
}

function closeTimelineDetails() {
    document.getElementById('timeline-details').style.display = 'none';
    document.querySelectorAll('.timeline-dot').forEach(dot => {
        dot.classList.remove('selected');
        dot.style.transform = 'scale(1)';
    });
}
</script>

<div class="card">
    <h3>Current State</h3>
    <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto;">{{.Session.State | printf "%#v"}}</pre>
</div>

<!-- Metrics Timeseries Visualization -->
{{if .Session.Metrics}}
<div class="card">
    <h2>Metrics Timeseries</h2>
    <p style="margin-bottom: 15px; color: #666;">
        Visualize how metrics changed over time during this session.
    </p>
    
    <div id="metric-charts"></div>
</div>

<script>
(function() {
    // Group metrics by name
    const metricsByName = {};
    const metrics = [
        {{range .Session.Metrics}}
        {
            name: "{{.Name}}",
            timestamp: new Date("{{.Timestamp.Format "2006-01-02T15:04:05Z07:00"}}"),
            value: {{.Value}},
            tags: [{{range .Tags}}"{{.}}",{{end}}]
        },
        {{end}}
    ];

    metrics.forEach(m => {
        if (!metricsByName[m.name]) {
            metricsByName[m.name] = [];
        }
        metricsByName[m.name].push(m);
    });

    // Create a chart for each metric
    const container = document.getElementById('metric-charts');
    Object.keys(metricsByName).sort().forEach((metricName, index) => {
        const metricData = metricsByName[metricName];
        
        // Sort by timestamp
        metricData.sort((a, b) => a.timestamp - b.timestamp);
        
        // Calculate statistics
        const values = metricData.map(m => m.value);
        const peak = Math.max(...values);
        const min = Math.min(...values);
        const avg = values.reduce((a, b) => a + b, 0) / values.length;
        
        // Create container for this chart
        const chartDiv = document.createElement('div');
        chartDiv.style.marginBottom = '30px';
        
        const title = document.createElement('h3');
        title.textContent = metricName;
        title.style.marginBottom = '10px';
        chartDiv.appendChild(title);
        
        const stats = document.createElement('p');
        stats.style.fontSize = '14px';
        stats.style.color = '#666';
        stats.style.marginBottom = '10px';
        stats.innerHTML = `<strong>Peak:</strong> ${peak.toFixed(2)} | <strong>Average:</strong> ${avg.toFixed(2)} | <strong>Min:</strong> ${min.toFixed(2)} | <strong>Points:</strong> ${metricData.length}`;
        chartDiv.appendChild(stats);
        
        const canvasContainer = document.createElement('div');
        canvasContainer.style.position = 'relative';
        canvasContainer.style.height = '300px';
        canvasContainer.style.marginBottom = '20px';
        
        const canvas = document.createElement('canvas');
        canvas.id = 'chart-' + index;
        canvasContainer.appendChild(canvas);
        chartDiv.appendChild(canvasContainer);
        
        container.appendChild(chartDiv);
        
        // Create chart
        new Chart(canvas, {
            type: 'line',
            data: {
                labels: metricData.map(m => m.timestamp),
                datasets: [{
                    label: metricName,
                    data: metricData.map(m => m.value),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                return metricName + ': ' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                second: 'HH:mm:ss',
                                minute: 'HH:mm',
                                hour: 'HH:mm'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Value'
                        }
                    }
                }
            }
        });
    });
})();
</script>
{{end}}

<!-- Events Table -->
<div class="card">
    <h3>Events ({{len .Session.Events}})</h3>
    <table>
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Name</th>
                <th>Data</th>
            </tr>
        </thead>
        <tbody>
            {{range .Session.Events}}
            <tr>
                <td>{{.Timestamp.Format "15:04:05"}}</td>
                <td><strong>{{.Name}}</strong></td>
                <td><pre style="margin: 0;">{{.Data | printf "%v"}}</pre></td>
            </tr>
            {{else}}
            <tr>
                <td colspan="3" style="text-align: center; padding: 20px; color: #999;">No events</td>
            </tr>
            {{end}}
        </tbody>
    </table>
</div>

<!-- Metrics Table -->
<div class="card">
    <h3>Metrics Data ({{len .Session.Metrics}})</h3>
    <table>
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Name</th>
                <th>Value</th>
                <th>Tags</th>
            </tr>
        </thead>
        <tbody>
            {{range .Session.Metrics}}
            <tr>
                <td>{{.Timestamp.Format "15:04:05"}}</td>
                <td><strong>{{.Name}}</strong></td>
                <td>{{printf "%.2f" .Value}}</td>
                <td>{{range .Tags}}<span class="badge" style="background: #e9ecef; color: #495057; margin: 2px;">{{.}}</span>{{end}}</td>
            </tr>
            {{else}}
            <tr>
                <td colspan="4" style="text-align: center; padding: 20px; color: #999;">No metrics</td>
            </tr>
            {{end}}
        </tbody>
    </table>
</div>

<a href="/" class="btn btn-secondary">Back to Dashboard</a>
{{end}}
