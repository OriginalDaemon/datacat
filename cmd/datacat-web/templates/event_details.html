{{define "event_details"}}
<div style="font-size: 12px;">
  <div style="margin-bottom: 6px;"><strong>Timestamp:</strong> {{.Event.Timestamp.Format "2006-01-02 15:04:05.000"}}</div>
  {{if .Event.Category}}
  <div style="margin-bottom: 6px;"><strong>Category:</strong> {{.Event.Category}}</div>
  {{end}}
  {{if .Event.Labels}}
  <div style="margin-bottom: 6px;"><strong>Labels:</strong> {{range $i, $label := .Event.Labels}}{{if $i}}, {{end}}{{$label}}{{end}}</div>
  {{end}}
  {{if .Event.ExceptionType}}
  <div style="margin-bottom: 6px; color: var(--error-color);"><strong>Exception:</strong> {{.Event.ExceptionType}}</div>
  {{if .Event.ExceptionMsg}}
  <div style="margin-bottom: 6px; color: var(--error-color);">{{.Event.ExceptionMsg}}</div>
  {{end}}
  {{end}}
  {{if .Event.SourceFile}}
  <div style="margin-bottom: 6px; font-family: monospace; font-size: 11px;"><strong>Source:</strong> {{.Event.SourceFile}}:{{.Event.SourceLine}}</div>
  {{end}}
  {{if .Event.Stacktrace}}
  <details style="margin-bottom: 6px;" open>
    <summary style="cursor: pointer; color: var(--text-secondary); font-weight: bold;">Stack Trace</summary>
    <div id="stacktrace-{{.Index}}" style="margin-top: 6px; padding: 8px; background: var(--bg-secondary); border-radius: 4px; font-size: 11px; overflow-x: auto; font-family: monospace; white-space: pre-wrap; word-wrap: break-word;"></div>
  </details>
  <script>
    (function() {
      const stacktrace = {{.Event.Stacktrace | toJSONSafe}};
      const container = document.getElementById('stacktrace-{{.Index}}');
      if (!container || !stacktrace || stacktrace.length === 0) return;

      // Parse and render stack trace with clickable file paths
      let html = '';
      for (let i = 0; i < stacktrace.length; i++) {
        let line = stacktrace[i];

        // Match Python traceback format: "  File \"path\", line X, in function"
        const fileMatch = line.match(/^(\s*File\s+)(["'])([^"']+)\2,\s*line\s+(\d+)(?:,\s*in\s+(.+))?/);
        if (fileMatch) {
          const prefix = fileMatch[1];
          const quote = fileMatch[2];
          const filePath = fileMatch[3];
          const lineNum = fileMatch[4];
          const functionName = fileMatch[5] || '';

          // Normalize file path for Windows (convert backslashes to forward slashes)
          const normalizedPath = filePath.replace(/\\/g, '/');

          // Create clickable links for different IDEs
          // VS Code: vscode://file/path:line
          // PyCharm: pycharm://open?file=path&line=line
          const vscodeLink = `vscode://file/${normalizedPath}:${lineNum}`;
          const pycharmLink = `pycharm://open?file=${encodeURIComponent(filePath)}&line=${lineNum}`;

          // Escape HTML in file path for display
          const escapedPath = filePath.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

          // Create clickable link (try VS Code first, then PyCharm)
          const linkHtml = `<a href="${vscodeLink}" onclick="
            try {
              window.location.href = '${vscodeLink}';
            } catch(e) {
              try {
                window.location.href = '${pycharmLink}';
              } catch(e2) {
                // Fallback: try to open file:// URL
                window.open('file://${normalizedPath}');
              }
            }
            return false;
          " style="color: var(--accent-primary); text-decoration: underline; cursor: pointer;" title="Click to open ${escapedPath}:${lineNum} in your IDE">${escapedPath}</a>`;

          // Replace the file path in the line with the clickable link
          const suffix = functionName ? `, in ${functionName}` : '';
          html += prefix + quote + linkHtml + quote + `, line ${lineNum}${suffix}\n`;
        } else {
          // Regular line - escape HTML but preserve formatting
          html += line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '\n';
        }
      }
      container.innerHTML = html;
    })();
  </script>
  {{end}}
  <div style="margin-bottom: 6px;"><strong>Data:</strong></div>
  <div id="event-json-{{.Index}}" class="json-viewer-container"></div>
</div>
<script>
  (function() {
    const data = {{.Event.Data | toJSONSafe}};
    new JSONViewer('event-json-{{.Index}}', data, { collapsed: false, maxHeight: '300px' });
  })();
</script>
{{end}}

